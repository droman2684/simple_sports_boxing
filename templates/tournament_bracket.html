{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="p">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1 style="margin:0">{{ tournament.name }}</h1>
        <div class="muted">{{ 'Exhibition (does not affect records)' if tournament.is_exhibition else 'Official (affects records)' }}</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a href="/tournaments">← All tournaments</a>
        <button id="simAllBtn" class="btn">Simulate Entire Bracket</button>
      </div>
    </div>
    {% set rounds = [1,2,3] %}
    {% for r in rounds %}
      <h2 style="margin-top:18px">Round {{ r }}</h2>
      <div class="grid" style="display:grid;gap:14px">
        {% for m in matches if m.round == r %}
          <div class="match" data-match-id="{{ m.match_id }}" style="border:1px solid #1f2937;border-radius:12px;padding:12px">
            <div class="muted" style="margin-bottom:6px">Bout #{{ m.bout_no }}</div>
            <div><strong>A:</strong> {{ m.boxer1_name or 'TBD' }}</div>
            <div><strong>B:</strong> {{ m.boxer2_name or 'TBD' }}</div>
            {% if m.winner_id %}
              <div style="margin-top:8px;font-weight:700">Winner: {{ m.winner_name }} ({{ m.method or 'UD' }}, {{ m.result_rounds or 12 }} rnds)</div>
            {% else %}
              <div class="controls" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:8px">
                <div><label>Winner</label><select class="winSel"><option value="">— select —</option>{% if m.boxer1_id %}<option value="{{ m.boxer1_id }}">{{ m.boxer1_name }}</option>{% endif %}{% if m.boxer2_id %}<option value="{{ m.boxer2_id }}">{{ m.boxer2_name }}</option>{% endif %}</select></div>
                <div><label>Method</label><select class="methodSel"><option value="UD">UD</option><option value="SD">SD</option><option value="MD">MD</option><option value="TKO">TKO</option><option value="KO">KO</option><option value="RTD">RTD</option><option value="DQ">DQ</option></select></div>
                <div><label>Rounds</label><input class="roundsInp" type="number" min="1" max="15" value="12" /></div>
              </div>
              <div style="margin-top:10px; display:flex; gap:10px">
                <button class="btn saveBtn">Save result</button>
                <button class="btn simBtn" style="background:#34d399;color:#052b19">Simulate</button>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
    {% if not matches or matches|length == 0 %}
      <p class="muted">No matches yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function showErr(resp, out, fallback){alert((out&&out.error)||fallback||('HTTP '+resp.status));}
document.querySelectorAll('.match').forEach(box=>{
  const sim=box.querySelector('.simBtn');if(sim){sim.addEventListener('click',async()=>{
    const matchId=box.getAttribute('data-match-id');
    const resp=await fetch(`/api/matches/${matchId}/simulate`,{method:'POST'});
    let out=null;try{out=await resp.json();}catch{}
    if(!resp.ok)return showErr(resp,out,'Server error simulating');
    location.reload();});}});
const simAll=document.getElementById('simAllBtn');
if(simAll){simAll.addEventListener('click',async()=>{
  const tid={{ tournament.tournament_id }};
  const resp=await fetch(`/api/tournaments/${tid}/simulate_all`,{method:'POST'});
  let out=null;try{out=await resp.json();}catch{}
  if(!resp.ok)return showErr(resp,out,'Server error simulating all');
  location.reload();});}
</script>
{% endblock %}
